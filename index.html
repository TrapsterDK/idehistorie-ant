<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <style>
            body {
                margin: 0;
            }
        </style>

        <script src="https://unpkg.com/3d-force-graph"></script>
        <!--<script src="../../dist/3d-force-graph.js"></script>-->
    </head>
    <body>
        <div id="3d-graph"></div>

        <script>
            class HSVColor {
                constructor(h, s, v) {
                    this.h = h;
                    this.s = s;
                    this.v = v;
                }

                toString() {
                    return `hsv(${this.h}, ${this.s}, ${this.v})`;
                }
            }

            const PARTICLES = 2;

            const ORANGE = new HSVColor(20, 1, 1);
            const CYAN = new HSVColor(180, 1, 1);
            const PINK = new HSVColor(328, 1, 1);

            // Random tree
            const N = 80;
            const gData = {
                nodes: [...Array(N).keys()].map((i) => ({
                    id: i,
                    color: [ORANGE, CYAN, PINK][Math.floor(Math.random() * 3)],
                })),
                links: [...Array(N).keys()]
                    .filter((id) => id)
                    .map((id) => ({
                        source: id,
                        target: Math.round(Math.random() * (id - 1)),
                    })),
            };

            // cross-link node objects
            gData.links.forEach((link) => {
                const a = gData.nodes[link.source];
                const b = gData.nodes[link.target];
                !a.neighbors && (a.neighbors = []);
                !b.neighbors && (b.neighbors = []);
                a.neighbors.push(b);
                b.neighbors.push(a);

                !a.links && (a.links = []);
                !b.links && (b.links = []);
                a.links.push(link);
                b.links.push(link);
            });

            const clickNodes = new Set();
            const clickLinks = new Set();
            let clickNode = null;

            const highlightNodes = new Set();
            const highlightLinks = new Set();
            let highlightNode = null;

            const Graph = ForceGraph3D()(document.getElementById("3d-graph"))
                .graphData(gData)
                .nodeRelSize(6)
                .nodeColor((node) => {
                    return node.color.toString();
                })
                .nodeOpacity(0.8)
                .linkDirectionalParticles((link) => {
                    if (clickLinks.has(link) || highlightLinks.has(link))
                        return PARTICLES;
                    return 0;
                })
                .linkDirectionalParticleColor((link) => {
                    return link.source.color.toString();
                })
                .linkDirectionalParticleWidth(5)
                .linkDirectionalParticleSpeed(0.005)
                .linkWidth(2)
                .onNodeClick((node) => {
                    // no state change
                    if (node && clickNode === node) return;

                    // clear state
                    clickNodes.clear();
                    clickLinks.clear();

                    // update state
                    clickNodes.add(node);
                    node.neighbors.forEach((neighbor) =>
                        clickNodes.add(neighbor)
                    );
                    node.links.forEach((link) => clickLinks.add(link));

                    clickNode = node;

                    UpdateGraph();
                })
                .onNodeHover((node) => {
                    // no state change
                    if (
                        (!node && !highlightNodes.size) ||
                        (node && highlightNode === node)
                    )
                        return;

                    // clear state
                    highlightNodes.clear();
                    highlightLinks.clear();

                    if (node) {
                        // update state
                        highlightNodes.add(node);

                        node.links.forEach((link) => highlightLinks.add(link));
                    }

                    highlightNode = node || null;

                    UpdateGraph();
                });

            // update graph
            function UpdateGraph() {
                Graph.nodeColor(Graph.nodeColor())
                    .linkDirectionalParticles(Graph.linkDirectionalParticles())
                    .nodeOpacity(Graph.nodeOpacity());
            }
        </script>
    </body>
</html>
